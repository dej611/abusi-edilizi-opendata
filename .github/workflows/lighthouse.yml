name: Lighthouse CI

on: 
  push:
    branches:
      - master
  watch:
    types: [started]

jobs:
  build:

    runs-on: ubuntu-latest
    
    if: github.actor == github.event.repository.owner.login

    steps:
      - uses: actions/checkout@v1
      - name: Deploy for staging
        env:
          BUILD_ID: ${{ github.sha }}
          ZEIT_TOKEN: ${{ secrets.ZEIT_TOKEN }}
        run: >
          now deploy
          --local-config=./now.json
          --build-env NODE_ENV=production
          --build-env BUILD_ID=${BUILD_ID}
          --env NODE_ENV=production
          --public
          --no-clipboard
          --token ${ZEIT_TOKEN}
          > ${HOME}/deployment-url.txt
      - name: Alias with PR number
        env:
          ZEIT_TOKEN: ${{ secrets.ZEIT_TOKEN }}
        run: >
          now alias
          --local-config=./now.json
          --token ${ZEIT_TOKEN}
          `cat ${HOME}/deployment-url.txt`
            ${{ github.event.repository.name }}-${{ github.sha }}-master.now.sh
      - name: Audit URLs using Lighthouse
        uses: treosh/lighthouse-ci-action@v2
        with:
          urls: |
            ${{ github.event.repository.name }}-${{ github.sha }}-master.now.sh/
            ${{ github.event.repository.name }}-${{ github.sha }}-master.now.sh/?lang=en
      - name: Save results
        uses: actions/upload-artifact@v1
        with:
          name: lighthouse-results
          path: '.lighthouseci' # This will save the Lighthouse results as .json files
